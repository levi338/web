

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Fornecedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        // SEGURANÇA
        if (!localStorage.getItem('usuarioLogado')) window.location.href = 'login.html';
    </script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-warning mb-4">
        <div class="container">
            <a class="navbar-brand text-dark" href="index.html">Sistema</a>
            <button onclick="window.location.href='index.html'" class="btn btn-outline-dark">Voltar</button>
        </div>
    </nav>
    <div class="container">
        <div id="lista" class="card p-4 shadow">
            <div class="d-flex justify-content-between mb-3"><h3>Fornecedores</h3><button onclick="mostrarForm()" class="btn btn-warning">Incluir</button></div>
            <table class="table table-striped">
                <thead><tr><th>Empresa</th><th>Contato</th><th>Email</th><th>CNPJ</th><th id="colAcoes">Ações</th></tr></thead>
                <tbody id="tabelaCorpo"></tbody>
            </table>
        </div>
        <div id="formulario" class="card p-4 shadow d-none">
            <h3 id="tituloForm">Fornecedor</h3>
            <form id="formDados">
                <input type="hidden" id="id">
                <div class="mb-2"><label>Empresa</label><input type="text" id="empresa" class="form-control" required></div>
                <div class="mb-2"><label>Nome Contato</label><input type="text" id="contato" class="form-control"></div>
                <div class="mb-2"><label>Email</label><input type="email" id="email" class="form-control"></div>
                <div class="mb-3"><label>CNPJ</label>
                    <input type="text" id="cnpj" class="form-control" maxlength="18" oninput="mascaraCNPJ(this)">
                </div>
                <button type="submit" class="btn btn-warning">Salvar</button>
                <button type="button" onclick="mostrarLista()" class="btn btn-secondary">Cancelar</button>
            </form>
        </div>
    </div>
    <script>
        const API = '/api/fornecedores';
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        const ehAdmin = usuarioLogado && usuarioLogado.perfil === 'Administrador';

        function mascaraCNPJ(input) {
            let v = input.value.replace(/\D/g, "");
            v = v.replace(/^(\d{2})(\d)/, "$1.$2");
            v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
            v = v.replace(/\.(\d{3})(\d)/, ".$1/$2");
            v = v.replace(/(\d{4})(\d)/, "$1-$2");
            input.value = v;
        }

        async function carregar() {
            const res = await fetch(API); const dados = await res.json();
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';
            if (!ehAdmin) document.getElementById('colAcoes').style.display = 'none';

            dados.map(f => {
                let botoes = '';
                if (ehAdmin) {
                    botoes = `<td><button class="btn btn-sm btn-primary" onclick='editar(${JSON.stringify(f)})'>Editar</button>
                              <button class="btn btn-sm btn-danger" onclick="excluir(${f.id})">Excluir</button></td>`;
                }
                tbody.innerHTML += `<tr><td>${f.empresa}</td><td>${f.contato}</td><td>${f.email}</td><td>${f.cnpj}</td>${botoes}</tr>`;
            });
        }
        document.getElementById('formDados').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('id').value;
            const body = {
                empresa: document.getElementById('empresa').value, contato: document.getElementById('contato').value,
                email: document.getElementById('email').value, cnpj: document.getElementById('cnpj').value
            };
            await fetch(id ? `${API}/${id}` : API, { method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)});
            mostrarLista(); carregar();
        };
        async function excluir(id) { if(confirm('Apagar?')) { await fetch(`${API}/${id}`, {method:'DELETE'}); carregar(); } }
        function mostrarForm() { document.getElementById('formDados').reset(); document.getElementById('id').value=''; document.getElementById('lista').classList.add('d-none'); document.getElementById('formulario').classList.remove('d-none'); }
        function editar(f) { mostrarForm(); document.getElementById('id').value=f.id; document.getElementById('empresa').value=f.empresa; document.getElementById('contato').value=f.contato; document.getElementById('email').value=f.email; document.getElementById('cnpj').value=f.cnpj; }
        function mostrarLista() { document.getElementById('lista').classList.remove('d-none'); document.getElementById('formulario').classList.add('d-none'); }
        carregar();
    </script>
</body>
</html>