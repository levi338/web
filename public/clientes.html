
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Clientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        // SEGURANÇA
        if (!localStorage.getItem('usuarioLogado')) window.location.href = 'login.html';
    </script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-success mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">Sistema</a>
            <button onclick="window.location.href='index.html'" class="btn btn-outline-light">Voltar</button>
        </div>
    </nav>
    <div class="container">
        <div id="lista" class="card p-4 shadow">
            <div class="d-flex justify-content-between mb-3"><h3>Clientes</h3><button onclick="mostrarForm()" class="btn btn-success">Incluir</button></div>
            <table class="table table-striped">
                <thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Cidade</th><th id="colAcoes">Ações</th></tr></thead>
                <tbody id="tabelaCorpo"></tbody>
            </table>
        </div>
        <div id="formulario" class="card p-4 shadow d-none">
            <h3 id="tituloForm">Cliente</h3>
            <form id="formDados">
                <input type="hidden" id="id">
                <div class="mb-2"><label>Nome</label><input type="text" id="nome" class="form-control" required></div>
                <div class="mb-2"><label>Email</label><input type="email" id="email" class="form-control"></div>
                <div class="mb-2"><label>Telefone</label>
                    <input type="text" id="telefone" class="form-control" maxlength="15" oninput="mascaraTelefone(this)">
                </div>
                <div class="mb-3"><label>Cidade</label><input type="text" id="cidade" class="form-control"></div>
                <button type="submit" class="btn btn-success">Salvar</button>
                <button type="button" onclick="mostrarLista()" class="btn btn-secondary">Cancelar</button>
            </form>
        </div>
    </div>
    <script>
        const API = '/api/clientes';
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        const ehAdmin = usuarioLogado && usuarioLogado.perfil === 'Administrador';

        function mascaraTelefone(input) {
            let v = input.value.replace(/\D/g, "");
            v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
            v = v.replace(/(\d)(\d{4})$/, "$1-$2");
            input.value = v;
        }

        async function carregar() {
            const res = await fetch(API); const dados = await res.json();
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';
            if (!ehAdmin) document.getElementById('colAcoes').style.display = 'none';

            dados.forEach(c => {
                let botoes = '';
                if (ehAdmin) {
                    botoes = `<td><button class="btn btn-sm btn-warning" onclick='editar(${JSON.stringify(c)})'>Editar</button>
                              <button class="btn btn-sm btn-danger" onclick="excluir(${c.id})">Excluir</button></td>`;
                }
                tbody.innerHTML += `<tr><td>${c.nome}</td><td>${c.email}</td><td>${c.telefone}</td><td>${c.cidade}</td>${botoes}</tr>`;
            });
        }
        
        document.getElementById('formDados').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('id').value;
            const body = {
                nome: document.getElementById('nome').value, email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value, cidade: document.getElementById('cidade').value
            };
            await fetch(id ? `${API}/${id}` : API, { method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)});
            mostrarLista(); carregar();
        };
        async function excluir(id) { if(confirm('Apagar?')) { await fetch(`${API}/${id}`, {method:'DELETE'}); carregar(); } }
        function mostrarForm() { document.getElementById('formDados').reset(); document.getElementById('id').value=''; document.getElementById('lista').classList.add('d-none'); document.getElementById('formulario').classList.remove('d-none'); }
        function editar(c) { mostrarForm(); document.getElementById('id').value=c.id; document.getElementById('nome').value=c.nome; document.getElementById('email').value=c.email; document.getElementById('telefone').value=c.telefone; document.getElementById('cidade').value=c.cidade; }
        function mostrarLista() { document.getElementById('lista').classList.remove('d-none'); document.getElementById('formulario').classList.add('d-none'); }
        carregar();
    </script>
</body>
</html>