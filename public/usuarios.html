

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Usuários - Sistema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        // SEGURANÇA: Se não estiver logado, manda para o login
        if (!localStorage.getItem('usuarioLogado')) {
            window.location.href = 'login.html';
        }
    </script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">Sistema de Gestão</a>
            <a href="index.html" class="btn btn-outline-light">Voltar</a>
        </div>
    </nav>
    
    <div class="container">
        <div id="lista" class="card p-4 shadow">
            <div class="d-flex justify-content-between mb-3">
                <h3>Lista de Usuários</h3>
                <button onclick="mostrarForm()" class="btn btn-success">Incluir Novo</button>
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Perfil</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo">
                    </tbody>
            </table>
        </div>

        <div id="formulario" class="card p-4 shadow d-none">
            <h3 id="tituloForm">Novo Usuário</h3>
            <form id="formDados">
                <input type="hidden" id="id">
                <div class="mb-2">
                    <label>Nome</label>
                    <input type="text" id="nome" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label>Email</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label>Login</label>
                    <input type="text" id="login" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label>Senha</label>
                    <input type="password" id="senha" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Perfil</label>
                    <select id="perfil" class="form-select">
                        <option>Administrador</option>
                        <option>Usuário</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Gravar</button>
                <button type="button" onclick="mostrarLista()" class="btn btn-secondary">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        // --- SEGURANÇA: VERIFICAÇÃO DE PERFIL ---
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        
        // Se não for Administrador, expulsa para o menu
        if (!usuarioLogado || usuarioLogado.perfil !== 'Administrador') {
            alert('Acesso Negado: Apenas administradores podem gerenciar usuários.');
            window.location.href = 'index.html';
        }

        const API = '/api/usuarios';

        // CARREGAR LISTA
        async function carregar() {
            const res = await fetch(API);
            const dados = await res.json();
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';
            
            // Pega os dados de quem está logado agora (EU)
            const eu = JSON.parse(localStorage.getItem('usuarioLogado'));

            dados.forEach(u => {
                let botoes = '';

                // LÓGICA DE PROTEÇÃO VISUAL
                // Se o usuário da linha for O MESMO que está logado (EU),
                // ou se for o "admin" principal, NÃO mostra o botão de excluir.
                if (u.id === eu.id || u.login === 'admin') {
                     botoes = `
                        <td>
                            <button class="btn btn-sm btn-warning" onclick='editar(${JSON.stringify(u)})'>Editar</button>
                            </td>`;
                } else {
                    // Para os outros, mostra tudo
                    botoes = `
                        <td>
                            <button class="btn btn-sm btn-warning" onclick='editar(${JSON.stringify(u)})'>Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="excluir(${u.id})">Excluir</button>
                        </td>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.nome}</td>
                        <td>${u.email}</td>
                        <td>${u.perfil}</td>
                        ${botoes}
                    </tr>`;
            });
        }

        // SALVAR (Incluir ou Editar)
        document.getElementById('formDados').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('id').value;
            const corpo = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                login: document.getElementById('login').value,
                senha: document.getElementById('senha').value,
                perfil: document.getElementById('perfil').value
            };
            
            await fetch(id ? `${API}/${id}` : API, {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(corpo)
            });
            mostrarLista();
            carregar();
        };

        // EXCLUIR
        async function excluir(id) {
            if(confirm('Tem certeza?')) {
                const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    carregar();
                } else {
                    const erro = await res.json();
                    alert(erro.erro || "Erro ao excluir");
                }
            }
        }

        // FUNÇÕES DE TELA
        function mostrarForm() {
            document.getElementById('formDados').reset();
            document.getElementById('id').value = '';
            document.getElementById('lista').classList.add('d-none');
            document.getElementById('formulario').classList.remove('d-none');
            document.getElementById('tituloForm').innerText = 'Incluir Usuário';
        }

        function editar(u) {
            mostrarForm();
            document.getElementById('tituloForm').innerText = 'Editar Usuário';
            document.getElementById('id').value = u.id;
            document.getElementById('nome').value = u.nome;
            document.getElementById('email').value = u.email;
            document.getElementById('login').value = u.login;
            document.getElementById('senha').value = u.senha;
            document.getElementById('perfil').value = u.perfil;
        }

        function mostrarLista() {
            document.getElementById('lista').classList.remove('d-none');
            document.getElementById('formulario').classList.add('d-none');
        }

        // Inicia carregando a lista
        carregar();
    </script>
</body>
</html>